# Timothy W. Hilton's attempt to compile STEM on edison.nersc.gov.
# Works using ifort on edison.nersc.gov (verified 27 Apr 2017).  The
# linker must be able to access libioapi.a compiled with the same
# compiler.

SHELL=/bin/sh

# necessary modules to load on edison: netcdf, cray-libsci

# on edison use the Cray wrapper "ftn" for compiling fortran.  The
# default compiler on edison is Intel (ifort).  wrappers cc and ftn
# are are MPI-aware so mpif90 does not need to be called explicitly.
# The wrappers point toward the default compiler.
# https://www.nersc.gov/users/computational-systems/edison/programming/
FC=ftn
LD=ftn
# The parallel compiler (Intel on edison)
PFC=ftn
PLD=ftn

# the "root" directory for stem, containing the src and run directories
STEMROOTDIR=$(PWD)
#the directory containing the stem sources
STEMSRCDIR=$(STEMROOTDIR)/
#the directory containing all the local libraries, sources, etc.
ROOTDIR=$(HOME)
PROJDIR=/project/projectdirs/m2319
#the directory in which to place the stem executables
#STEMRUNDIR=$(STEMROOTDIR)
STEMRUNDIR=/global/cscratch1/sd/twhilton/STEM_tests/STEM_adjCOS

# The Vis5D home directory
V5DHOME=/usr/local/vis5d-5.2

APINCL=-I$(PROJDIR)/local/include
APILIB= -L$(PROJDIR)/local/lib -lioapi -lnetcdf

# ---- Include Directory ----
DIRINCL=$(STEMSRCDIR)/Include
# The Stem Common Blocks and other Things to Include
STEMINCL=-I$(DIRINCL) -I$(STEMSRCDIR)/Tuvsub
FFLAGS   = -c -O $(APINCL) $(STEMINCL) -dynamic
PFFLAGS  = -c -O $(APINCL) $(STEMINCL) -dynamic
LDFLAGS  = -O  -qopenmp -lpthread -dynamic
PLDFLAGS = -O  -qopenmp -lpthread -dynamic

# use debugging compiler and linker flags if debug target specified
# use explicit O0 flag during debugging so that compiler does not
# optimize any variables away
debug:FFLAGS  += -g -O0
debug:PFFLAGS  += -g -O0
debug:LDFLAGS  += -g -O0
debug:PLDFLAGS += -g -O0

# at NERSC lapack and blas are included in the module cray-libsci, and
# found automatically by the cray compiler wrappers ftn and cc.  If
# the module cray-libsci is loaded no further action is necessary.
MATHLIB= # -llapack -lblas

CMDOPT = $(STEMRUNDIR)/adj_COS_main.exe
CMDFUN = $(STEMRUNDIR)/adj_COS_fun.exe

all:  $(CMDFUN) $(CMDOPT)
debug: all

#  ---- DRIVER Files ----
DIRDRV=Drivers
SRCDRVFUN=  aq_driver_function.f
OBJDRVFUN=  aq_driver_function.o
SRCDRVOPT=  aq_driver_opt.f
OBJDRVOPT=  aq_driver_opt.o


# ---- Transport Files ----
DIRTRAN=$(STEMSRCDIR)/Transport
SRCTRAN= advdiff_1d_finitediff_conc.f90 advdiff_1d_finitediff_mf_em.f90 \
	 advdiff_1d_finitevol_conc.f90 cartesian2sigma.f90
OBJTRAN= advdiff_1d_finitediff_conc.o advdiff_1d_finitediff_mf_em.o \
	 advdiff_1d_finitevol_conc.o cartesian2sigma.o

# ---- Utility Files ----
DIRUTIL=$(STEMSRCDIR)/Util
SRCUTIL= setup.f  aq_lib.f  convert.f
OBJUTIL= setup.o  aq_lib.o  convert.o

# ---- Memory Management Files ----
DIRMEM=$(STEMSRCDIR)/Memory
SRCMEM=stem_memalloc.f
OBJMEM=stem_memalloc.o

# ---- Parallelization Files ----
DIRPAR=$(STEMSRCDIR)/Paqmsg
SRCMPI= paqmsg_util.f paqmsg_library.f paqmsg_communication.f \
        paqmsg_stem.f
OBJPAR= paqmsg_util.o paqmsg_library.o paqmsg_communication.o \
	paqmsg_stem.o

# --------------Input/Output Files -----------------------------------
DIRIO=$(STEMSRCDIR)/IO
SRCIO=input_ioapi.f output_ioapi.f checkpoints.f
OBJIO=input_ioapi.o output_ioapi.o checkpoints.o

# -------------- Gas Chemistry Files -----------------------------------
DIRGCHEM=$(STEMSRCDIR)/GasChemistry
SRCGCHEM=rxn_eq.f saprcnov_stem_model.f saprcnov_stem_integrator.f \
	saprcnov_stem_linalg.f  saprcnov_stem_hessian.f \
	rxn_adjoint.f
OBJGCHEM=rxn_eq.o saprcnov_stem_model.o saprcnov_stem_integrator.o \
	saprcnov_stem_linalg.o  saprcnov_stem_hessian.o \
	rxn_adjoint.o
HEADGCHEM=  $(DIRGCHEM)/saprcnov_stem.h $(DIRGCHEM)/saprcnov_stem_s.h

# --------------Radiation Files --------------------------------------
DIRTUV=$(STEMSRCDIR)/Tuvsub
SRCTUV=tuvsub.f
OBJTUV=tuvsub.o


# --------------Optimization Files -----------------------------------
DIROPT=$(STEMSRCDIR)/Optimization
SRCOPT=setulb.f
OBJOPT=setulb.o


# -------------- All Objects ------------------------
OBJ =  $(OBJLIB) $(OBJPAR) $(OBJTRAN) $(OBJIO) \
	$(OBJTUV) $(OBJGCHEM) $(OBJMEM) $(OBJUTIL) \
	$(OBJOPT)

$(CMDFUN):  $(OBJ) $(OBJDRVFUN) $(DIRINCL)/aqms.param
	$(PLD) $(PLDFLAGS) -o $(CMDFUN) $(OBJ) $(OBJDRVFUN)  \
	$(APILIB) $(MATHLIB)

$(CMDOPT):  $(OBJ) $(OBJDRVOPT) $(DIRINCL)/aqms.param
	$(PLD) $(PLDFLAGS) -o $(CMDOPT) $(OBJ) $(OBJDRVOPT)  \
	$(APILIB) $(MATHLIB)

f.o:
	$(FC) $(FFLAGS) $(APINCL) $<

f90.o:
	$(FC) $(FFLAGS) $(APINCL) $<

# --------------Driver Files --------------------------------------
aq_driver_function.o:$(DIRDRV)/aq_driver_function.f $(DIRINCL)/aqms.param
	$(FC) $(FFLAGS) $<

aq_driver_opt.o:$(DIRDRV)/aq_driver_opt.f $(DIRINCL)/aqms.param
	$(FC) $(FFLAGS) $<

# --------------Parallelization Files --------------------------------
paqmsg_util.o: $(DIRPAR)/paqmsg_util.f
	$(PFC) $(PFFLAGS) $<

paqmsg_library.o: $(DIRPAR)/paqmsg_library.f
	$(PFC) $(PFFLAGS) $<

paqmsg_communication.o: $(DIRPAR)/paqmsg_communication.f
	$(PFC) $(PFFLAGS) $<

paqmsg_stem.o: $(DIRPAR)/paqmsg_stem.f
	$(PFC) $(PFFLAGS) $<
# ------------------------------------------------------------------------


# -------------- Utility Files --------------------------------------
aq_lib.o: $(DIRUTIL)/aq_lib.f $(DIRINCL)/aqms.param
	$(FC) $(FFLAGS) $<

setup.o: $(DIRUTIL)/setup.f $(DIRINCL)/aqms.param
	$(FC) $(FFLAGS) $<

convert.o: $(DIRUTIL)/convert.f $(DIRINCL)/aqms.param
	$(FC) $(FFLAGS) $<
# ------------------------------------------------------------------------


# --------------Transport Files --------------------------------------
advdiff_1d_finitediff_conc.o: $(DIRTRAN)/advdiff_1d_finitediff_conc.f90 \
	$(DIRINCL)/aqms.param
	$(FC) $(FFLAGS) $<

advdiff_1d_finitevol_conc.o: $(DIRTRAN)/advdiff_1d_finitevol_conc.f90 \
	$(DIRINCL)/aqms.param
	$(FC) $(FFLAGS) $<

advdiff_1d_finitediff_mf_em.o: $(DIRTRAN)/advdiff_1d_finitediff_mf_em.f90 \
	$(DIRINCL)/aqms.param
	$(FC) $(FFLAGS) $<

cartesian2sigma.o: $(DIRTRAN)/cartesian2sigma.f90 $(DIRINCL)/aqms.param
	$(FC) $(FFLAGS) $<
# ------------------------------------------------------------------------


# -------------- Gas-Phase Chemistry Files -----------------------------------
rxn_eq.o:  $(DIRGCHEM)/rxn_eq.f $(HEADGCHEM)
	$(FC) $(FFLAGS) $<

saprcnov_stem_model.o: $(DIRGCHEM)/saprcnov_stem_model.f $(HEADGCHEM)
	$(FC) $(FFLAGS) $<

saprcnov_stem_integrator.o: $(DIRGCHEM)/saprcnov_stem_integrator.f $(HEADGCHEM)
	$(FC) $(FFLAGS) $<

saprcnov_stem_linalg.o: $(DIRGCHEM)/saprcnov_stem_linalg.f $(HEADGCHEM)
	$(FC) $(FFLAGS) $<

saprcnov_stem_hessian.o: $(DIRGCHEM)/saprcnov_stem_hessian.f $(HEADGCHEM)
	$(FC) $(FFLAGS) $<

rxn_adjoint.o:  $(DIRGCHEM)/rxn_adjoint.f $(HEADGCHEM)
	$(FC) $(FFLAGS) $<
# ------------------------------------------------------------------------


# ------------ Memory Management Files --------------------------------
stem_memalloc.o: $(DIRMEM)/stem_memalloc.f
	$(FC) $(FFLAGS) $<
# ------------------------------------------------------------------------


# -------------- Radiation Files --------------------------------------
tuvsub.o: $(DIRTUV)/tuvsub.f $(DIRTUV)/tuv.params
	$(FC) $(FFLAGS) $<
# ------------------------------------------------------------------------


# --------------Input/Output Files --------------------------------------
checkpoints.o: $(DIRIO)/checkpoints.f
	$(FC) $(FFLAGS) $<

input_ioapi.o: $(DIRIO)/input_ioapi.f
	$(FC) $(FFLAGS) $<

output_ioapi.o: $(DIRIO)/output_ioapi.f
	$(FC) $(FFLAGS) $<
# ------------------------------------------------------------------------

# --------------Optimization Files -----------------------------------
setulb.o: $(DIROPT)/setulb.f
	$(FC) $(FFLAGS) $<

clean:
	rm -fv $(OBJ) $(OBJDRV) $(OBJDRVFUN) $(OBJDRVOPT) $(LIBS)

clobber: clean
	rm -fv $(CMDOPT) $(CMDFUN) ./*.mod
